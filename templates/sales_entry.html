<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Entry Form</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@tailwindcss/browser@latest"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='custom.css') }}">
</head>
<body class="bg-gray-100 font-inter antialiased">
{% extends 'base.html' %}
{% block content %}
<div class="min-h-screen flex justify-center items-center py-10 main-content">
    <div class="bg-white rounded-lg shadow-md w-full max-w-3xl p-6 form-container" id="sales-form-container">
        <div class="logo-container">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Company Logo" class="logo">
        </div>
        <h1 class="text-2xl font-semibold text-gray-800 mb-6 text-center">Sales Entry</h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <label for="sales-date" class="block text-gray-700 text-sm font-bold mb-2 text-left">Sales Date:</label>
                <input type="date" id="sales-date" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <div>
                <label for="executive-name" class="block text-gray-700 text-sm font-bold mb-2 text-left">Executive Name:</label>
                <select id="executive-name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <option value="">Select Executive</option>
                </select>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div class="flex flex-col justify-end">
                <div class="customer-id-label-container">
                    <label for="customer-contact-input" class="text-gray-700 text-sm font-bold mb-2 text-left">Customer Contact:</label>
                    <a href="{{ url_for('main.add_customer') }}" class="add-customer-link ml-2" target="_blank">Add New Customer</a>
                </div>
                <div class="customer-id-container">
                    <input type="text" id="customer-contact-input" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Enter Customer Contact Number">
                    <input type="hidden" id="customer-id-hidden">
                </div>
            </div>
            <div class="flex flex-col justify-end">
                <label for="customer-name" class="block text-gray-700 text-sm font-bold mb-2 text-left">Customer Name:</label>
                <input type="text" id="customer-name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-500 leading-tight focus:outline-none focus:shadow-outline" readonly>
            </div>
        </div>

        <table id="product-table" class="mb-6">
            <thead>
                <tr>
                    <th>Product ID</th>
                    <th>Product Name</th>
                    <th>Quantity</th>
                    <th>Price Per Unit</th>
                    <th>Amount</th>
                </tr>
            </thead>
            <tbody>
                <!-- Initial Row -->
                <tr>
                    <td>
                        <select class="product-id shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            <option value="">Select Product ID</option>
                        </select>
                    </td>
                    <td>
                        <select class="product-name shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            <option value="">Select Product Name</option>
                        </select>
                    </td>
                    <td><input type="number" class="quantity-sold shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" min="0"></td>
                    <td><input type="number" class="price-per-unit shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" min="0" step="0.01"></td>
                    <td class="amount">₹0.00</td>
                </tr>
            </tbody>
        </table>

        <table id="product-table-mobile" class="mb-6">
            <thead>
                <tr>
                    <th>Product ID</th>
                    <th>Product Name</th>
                    <th>Quantity Sold</th>
                    <th>Price Per Unit</th>
                    <th>Amount (Before Discount/GST)</th>
                </tr>
            </thead>
            <tbody>
                <!-- Initial Row for Mobile -->
                <tr>
                    <td>
                        <label>Product ID</label>
                        <select class="product-id shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            <option value="">Select Product ID</option>
                        </select>
                    </td>
                    <td>
                        <label>Product Name</label>
                        <select class="product-name shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            <option value="">Select Product Name</option>
                        </select>
                    </td>
                    <td>
                        <label>Quantity Sold</label>
                        <input type="number" class="quantity-sold shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" min="0">
                    </td>
                    <td>
                        <label>Price Per Unit</label>
                        <input type="number" class="price-per-unit shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" min="0" step="0.01">
                    </td>
                    <td class="amount">₹0.00</td>
                </tr>
            </tbody>
        </table>

        <div class="mb-6">
            <button id="add-product" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Add Product</button>
        </div>

        <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label for="discount" class="block text-gray-700 text-sm font-bold mb-2 text-left">Overall Discount Amount:</label>
                <input type="number" id="discount" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="" placeholder="Enter discount amount" min="0" step="0.01">
            </div>
        </div>

        <div class="totals-summary mb-6 p-4 border rounded-md bg-gray-50">
            <h3 class="text-lg font-semibold mb-3 text-gray-700">Invoice Summary</h3>
            <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                <span class="text-gray-600">Gross Amount (Before GST):</span>
                <span id="total-amount" class="text-right font-medium text-gray-800">₹0.00</span>

                <span class="text-gray-600">Overall Discount:</span>
                <span id="discount-amount-display" class="text-right font-medium text-gray-800">₹0.00</span>

                <span class="text-gray-600">Net Amount (After Discount, Before GST):</span>
                <span id="total-after-discount" class="text-right font-medium text-gray-800">₹0.00</span>

                <span class="text-gray-600">Total GST:</span>
                <span id="cgst" class="text-right font-medium text-gray-800">₹0.00</span>

                <hr class="col-span-2 my-1 border-gray-300">

                <span class="text-gray-700 font-bold text-base">Total Payable Amount:</span>
                <span id="total-payable-amount" class="text-right font-bold text-base text-indigo-600">₹0.00</span>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <label for="mode-of-payment" class="block text-gray-700 text-sm font-bold mb-2 text-left">Mode of Payment:</label>
                <select id="mode-of-payment" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <option value="" selected disabled>Select Mode of Payment</option>
                    <option value="Cash">Cash</option>
                    <option value="Card">Card</option>
                    <option value="UPI">UPI</option>
                    <option value="Bank">Bank</option>
                </select>
            </div>
            <div>
                <label for="payment-option" class="block text-gray-700 text-sm font-bold mb-2 text-left">Payment Option:</label>
                <select id="payment-option" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <option value="full-payment" selected>Full Payment</option>
                    <option value="partial-payment">Partial Payment</option>
                </select>
            </div>
        </div>

        <div class="mb-4" id="partial-payment-amount" style="display: none;">
            <label for="amount" class="block text-gray-700 text-sm font-bold mb-2 text-left">Partial Payment Amount:</label>
            <input type="number" id="amount" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" min="0" step="0.01">
        </div>

        <div id="final-total-amount-container" class="mb-6">
            <label class="block text-gray-700 text-sm font-bold mb-2 text-left">Amount Paid:</label>
            <input type="number" id="final-total-amount" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" readonly min="0" step="0.01">
        </div>
        <div class="mb-4">
            <label for="notes" class="block text-gray-700 text-sm font-bold mb-2 text-left">Notes:</label>
            <textarea id="notes" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" rows="3"></textarea>
        </div>

        <div class="flex flex-row items-center justify-between mt-4">
            <button id="submit-sales-form" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Submit Sale</button>
            <div style="display: flex; justify-content: flex-end; margin-top: 0;">
                <a href="{{ url_for('main.sales_return') }}" class="btn btn-secondary" style="padding: 12px 24px; background: #f4f7fa; color: #023f90; border: 2px solid #023f90; border-radius: 8px; font-size: 16px; text-decoration: none; transition: background 0.2s, color 0.2s;">
                    Sales Return
                </a>
            </div>
        </div>
    </div>
</div>
<script>
    const paymentOptionSelect = document.getElementById('payment-option');
    const partialPaymentAmountDiv = document.getElementById('partial-payment-amount');
    const addProductButton = document.getElementById('add-product');
    const productTable = document.getElementById('product-table').getElementsByTagName('tbody')[0]; // Get tbody directly
    const productTableMobile = document.getElementById('product-table-mobile').getElementsByTagName('tbody')[0]; // Get tbody directly
    const totalAmountDisplay = document.getElementById('total-amount');
    const cgstDisplay = document.getElementById('cgst');
    const finalTotalAmountInput = document.getElementById('final-total-amount');
    const totalPayableAmountDisplay = document.getElementById('total-payable-amount');
    const customerContactInput = document.getElementById('customer-contact-input'); // Changed from customerIdInput
    const customerIdHiddenInput = document.getElementById('customer-id-hidden'); // New hidden input for actual ID
    const customerNameInput = document.getElementById('customer-name');
    const salesDateInput = document.getElementById('sales-date');
    const executiveNameSelect = document.getElementById('executive-name');
    const discountInput = document.getElementById('discount');
    const discountAmountDisplay = document.getElementById('discount-amount-display');
    const totalAfterDiscountDisplay = document.getElementById('total-after-discount');
    const submitSalesFormButton = document.getElementById('submit-sales-form');
    const modeOfPaymentInput = document.getElementById('mode-of-payment');
    const partialAmountInput = document.getElementById('amount'); // Input field for partial amount
    const finalTotalAmountContainer = document.getElementById('final-total-amount-container'); // Container for Amount Paid
    const notesInput = document.getElementById('notes');


    let allProducts = []; // To store fetched product data {product_id, product_name, product_code, price_per_unit (null), gst_percentage}
    // let allCustomers = []; // Not fetching all customers initially anymore
    let allExecutives = [];

    // HTML structure for a new row (desktop)
    const desktopRowHTML = `
        <td>
            <select class="product-id shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                <option value="">Select Product ID</option>
            </select>
        </td>
        <td>
            <select class="product-name shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                <option value="">Select Product Name</option>
            </select>
        </td>
        <td><input type="number" class="quantity-sold shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" min="0"></td>
        <td><input type="number" class="price-per-unit shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" min="0" step="0.01"></td>
        <td class="amount">₹0.00</td>
    `;

    // HTML structure for a new row (mobile)
    const mobileRowHTML = `
        <td>
            <label>Product ID</label>
            <select class="product-id shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                <option value="">Select Product ID</option>
            </select>
        </td>
        <td>
            <label>Product Name</label>
            <select class="product-name shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                <option value="">Select Product Name</option>
            </select>
        </td>
        <td>
            <label>Quantity Sold</label>
            <input type="number" class="quantity-sold shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" min="0">
        </td>
        <td>
            <label>Price Per Unit</label>
            <input type="number" class="price-per-unit shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" min="0" step="0.01">
        </td>
        <td class="amount">₹0.00</td>
    `;


    document.addEventListener('DOMContentLoaded', async () => {
        salesDateInput.value = new Date().toISOString().split('T')[0];
        await fetchInitialData();
        attachEventListenersToRow(productTable.querySelector('tr'));
        attachEventListenersToRow(productTableMobile.querySelector('tr'));
        calculateTotal();
        updatePaymentFields(); // Initial call to set visibility
    });

    async function fetchInitialData() {
        try {
            const [productsRes, fetchedExecutivesRes] = await Promise.all([
                fetch('/api/products'),
                // fetch('/api/customers'), // Removed, fetching individual customer on ID input
                fetch('/api/executives')
            ]);

            if (!productsRes.ok) throw new Error(`Failed to fetch products: ${productsRes.statusText}`);
            allProducts = await productsRes.json();

            // if (!customersRes.ok) throw new Error(`Failed to fetch customers: ${customersRes.statusText}`);
            // allCustomers = await customersRes.json();

            if (!fetchedExecutivesRes.ok) throw new Error(`Failed to fetch executives: ${fetchedExecutivesRes.statusText}`);
            allExecutives = await fetchedExecutivesRes.json();


            populateExecutiveDropdown();
            populateProductDropdownsInRow(productTable.querySelector('tr'));
            populateProductDropdownsInRow(productTableMobile.querySelector('tr'));

            customerContactInput.addEventListener('blur', async function() { // Listen to contact input
                const enteredContact = this.value.trim();
                customerNameInput.value = ''; // Clear previous name
                customerIdHiddenInput.value = ''; // Clear previous ID

                if (enteredContact === '') {
                    customerNameInput.value = '';
                    return;
                }
                try {
                    const response = await fetch(`/api/customer/by-contact/${enteredContact}`); // New API endpoint
                    if (response.ok) {
                        const customer = await response.json();
                        if (customer && customer.customer_id) {
                            customerNameInput.value = customer.customer_name;
                            customerIdHiddenInput.value = customer.customer_id; // Store the fetched ID
                        } else {
                            // This case: 200 OK, but data is not as expected (e.g. API bug or empty success)
                            // Backend should ideally return 404 if not found.
                            customerNameInput.value = "Customer data not found. Use 'Add New Customer' link.";
                        }
                    } else if (response.status === 404) {
                        // const errorData = await response.json(); // No need to parse if using a static message
                        customerNameInput.value = "No customer found. Use 'Add New Customer' link.";
                    } else {
                        // Other HTTP errors (500, 403, etc.)
                        customerNameInput.value = `Error: ${response.statusText}. Please try again.`;
                        console.error('Failed to fetch customer by contact:', response.status, response.statusText);
                    }
                } catch (error) {
                    // Network error or JSON parsing error
                    console.error('Error fetching customer details by contact:', error);
                    customerNameInput.value = 'Network error or invalid response.';
                }
            });

        } catch (error) {
            console.error("Error fetching initial data:", error);
            alert("Error loading initial data. Please check console for details and ensure backend APIs are running.");
        }
    }

    function populateExecutiveDropdown() {
        executiveNameSelect.innerHTML = '<option value="">Select Executive</option>';
        allExecutives.forEach(executive => {
            const option = document.createElement('option');
            option.value = executive.id; // Use ID as value
            option.textContent = executive.full_name; // Display name
            executiveNameSelect.appendChild(option);
        });
    }

    function populateProductDropdownsInRow(rowElement) {
        const productIdSelect = rowElement.querySelector('.product-id');
        const productNameSelect = rowElement.querySelector('.product-name');

        productIdSelect.innerHTML = '<option value="">Select Product ID</option>';
        productNameSelect.innerHTML = '<option value="">Select Product Name</option>';

        allProducts.forEach(product => {
            const optionId = document.createElement('option');
            optionId.value = product.product_id;
            optionId.textContent = `${product.product_code} - ${product.product_name}`; // Show code and name
            productIdSelect.appendChild(optionId);

            const optionName = document.createElement('option');
            optionName.value = product.product_id; // Use product_id as value for easier sync
            optionName.textContent = `${product.product_name} (${product.product_code})`;
            productNameSelect.appendChild(optionName);
        });

        productIdSelect.addEventListener('change', function() {
            productNameSelect.value = this.value; // Sync by product_id
            calculateTotal();
        });

        productNameSelect.addEventListener('change', function() {
            productIdSelect.value = this.value; // Sync by product_id
            calculateTotal();
        });
    }

    function updatePaymentFields() {
        if (paymentOptionSelect.value === 'partial-payment') {
            partialPaymentAmountDiv.style.display = 'block'; // Show partial amount input div
            finalTotalAmountContainer.style.display = 'none'; // Hide final amount container
        } else {
            partialPaymentAmountDiv.style.display = 'none'; // Hide partial amount input div
            finalTotalAmountContainer.style.display = 'block'; // Show final amount container
            finalTotalAmountInput.readOnly = true;
            // finalTotalAmountInput.value will be set by calculateTotal
            calculateTotal(); // Recalculate to set full amount if switching from partial
        }
    }

    // No need for partialAmountInput listener to update finalTotalAmountInput anymore as it's hidden


    addProductButton.addEventListener('click', function() {
        if (allProducts.length === 0) { alert("Product data not loaded yet. Please wait or refresh."); return; }

        const activeTableBody = window.innerWidth < 768 ? productTableMobile : productTable;
        const newRow = activeTableBody.insertRow();
        newRow.innerHTML = window.innerWidth < 768 ? mobileRowHTML : desktopRowHTML;

        populateProductDropdownsInRow(newRow);
        attachEventListenersToRow(newRow);
    });

    function attachEventListenersToRow(rowElement) {
        const inputs = rowElement.querySelectorAll('input.quantity-sold, input.price-per-unit');
        inputs.forEach(input => {
            input.addEventListener('input', calculateTotal);
        });
        // Selects already have listeners from populateProductDropdownsInRow
    }

    function formatIndianCurrency(amount) {
        if (isNaN(amount) || amount === null) amount = 0;
        return amount.toLocaleString('en-IN', {
            style: 'currency',
            currency: 'INR',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
        });
    }

    function calculateTotal() {
        let grossAmountBeforeGST = 0;
        const activeTableBody = window.innerWidth < 768 ? productTableMobile : productTable;
        const rows = activeTableBody.querySelectorAll('tr');
        const itemCalculations = [];

        rows.forEach(row => {
            const quantityInput = row.querySelector('.quantity-sold');
            const pricePerUnitInput = row.querySelector('.price-per-unit');
            const amountCell = row.querySelector('.amount');
            const productIdSelect = row.querySelector('.product-id');

            const quantity = parseFloat(quantityInput.value) || 0;
            const pricePerUnit = parseFloat(pricePerUnitInput.value) || 0;
            const selectedProductId = productIdSelect.value;

            const product = allProducts.find(p => String(p.product_id) === selectedProductId);
            const gstPercentage = product && product.gst_percentage !== null ? parseFloat(product.gst_percentage) : 0;

            if (quantity > 0 && pricePerUnit >= 0) {
                const itemAmountBeforeGST = quantity * pricePerUnit;
                amountCell.textContent = formatIndianCurrency(itemAmountBeforeGST);
                grossAmountBeforeGST += itemAmountBeforeGST;

                itemCalculations.push({
                    amountBeforeGST: itemAmountBeforeGST,
                    gstPercentage: gstPercentage
                });
            } else {
                amountCell.textContent = formatIndianCurrency(0);
            }
        });

        if(totalAmountDisplay) totalAmountDisplay.textContent = formatIndianCurrency(grossAmountBeforeGST);

        const discountValue = parseFloat(discountInput.value) || 0;
        if(discountAmountDisplay) discountAmountDisplay.textContent = formatIndianCurrency(discountValue);

        const netAmountBeforeGST = Math.max(0, grossAmountBeforeGST - discountValue);
        if(totalAfterDiscountDisplay) totalAfterDiscountDisplay.textContent = formatIndianCurrency(netAmountBeforeGST);

        let totalGSTAmount = 0;
        if (grossAmountBeforeGST > 0) {
            itemCalculations.forEach(item => {
                const proportionateNetAmount = (item.amountBeforeGST / grossAmountBeforeGST) * netAmountBeforeGST;
                const itemGSTAmount = proportionateNetAmount * (item.gstPercentage / 100);
                if (!isNaN(itemGSTAmount)) totalGSTAmount += itemGSTAmount;
            });
        }

        cgstDisplay.textContent = formatIndianCurrency(totalGSTAmount);
        const totalPayable = netAmountBeforeGST + totalGSTAmount;
        totalPayableAmountDisplay.textContent = formatIndianCurrency(totalPayable);

        if (paymentOptionSelect.value === 'full-payment') {
            // Only update finalTotalAmountInput if full payment is selected
            finalTotalAmountInput.value = totalPayable.toFixed(2);
            // The readOnly status is handled by updatePaymentFields
            // The visibility is handled by updatePaymentFields
        }
        // If partial, the finalTotalAmountInput is hidden, and the partialAmountInput is used for input.
        // Its value is not automatically updated here.
    }

    discountInput.addEventListener('input', calculateTotal);

    submitSalesFormButton.addEventListener('click', async function(event) {
        event.preventDefault();

        const salesData = {
            sales_date: salesDateInput.value,
            executive_id: executiveNameSelect.value, // Now sending ID
            customer_id: customerIdHiddenInput.value, // Use the hidden ID field
            // customer_name: customerNameInput.value, // Backend can fetch this if needed
            mode_of_payment: modeOfPaymentInput.value,
            payment_option: paymentOptionSelect.value,
            // amount_paid will be set below based on payment option
            notes: notesInput.value.trim(),
            overall_discount_amount: parseFloat(discountInput.value) || 0, // Added for backend
            items: []
        };

        const activeTableBody = window.innerWidth < 768 ? productTableMobile : productTable;
        const rows = activeTableBody.querySelectorAll('tr');
        let hasValidItem = false;
        rows.forEach(row => {
            const productId = row.querySelector('.product-id').value;
            const quantitySold = parseFloat(row.querySelector('.quantity-sold').value);
            const pricePerUnit = parseFloat(row.querySelector('.price-per-unit').value);

            if (productId && quantitySold > 0 && pricePerUnit >= 0) {
                salesData.items.push({
                    product_id: productId,
                    quantity_sold: quantitySold,
                    price_per_unit_before_gst: pricePerUnit // Key name matches backend expectation
                });
                hasValidItem = true;
            }
        });

        if (!salesData.sales_date) { alert("Sales Date is required."); return; }
        if (!salesData.customer_id) {
            alert("Customer details not found or contact is invalid. Please verify customer contact."); return;
        }
        // Check if customer name indicates an issue
        if (customerNameInput.value.toLowerCase().includes('not found') || customerNameInput.value.toLowerCase().includes('error fetching') || customerNameInput.value === '') {
            alert("Please enter a valid Customer ID and ensure customer details are loaded."); return;
        }
         if (!salesData.mode_of_payment) { alert("Mode of Payment is required."); return; }
        if (!hasValidItem) { alert("Please add at least one valid product item."); return; }
        if (salesData.overall_discount_amount < 0) { alert("Discount cannot be negative."); return; }


        const totalPayableNum = parseFloat(totalPayableAmountDisplay.textContent.replace(/[^0-9.-]+/g,""));

        // Get the amount paid value based on the selected payment option
        const amountPaidValue = salesData.payment_option === 'partial-payment' ? parseFloat(partialAmountInput.value) || 0 : totalPayableNum; // For full payment, amount paid is total payable
        salesData.amount_paid_by_customer = amountPaidValue; // Key name matches backend expectation


        // Validation specific to payment options
        if (salesData.payment_option === 'full-payment') {
             // Allow small rounding differences, or force exact match
            if (Math.abs(salesData.amount_paid - totalPayableNum) > 0.01) {
                 alert("For full payment, amount paid must match total payable amount."); return;
            }
            // If it's close enough, set it to the exact total payable amount
            salesData.amount_paid_by_customer = totalPayableNum; // Ensure it's exactly the total payable
        }

        if (salesData.payment_option === 'partial-payment') {
            if (salesData.amount_paid <= 0) {
                alert("For partial payment, amount paid must be greater than zero."); return;
            }
            if (salesData.amount_paid > totalPayableNum) {
                alert("Partial amount paid cannot be greater than total payable amount."); return;
            }
        }


        try {
            const response = await fetch('/api/sales', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(salesData),
            });

            const result = await response.json();

            if (response.ok) {
                alert(`${result.message || "Sales invoice created successfully!"} Invoice Number: ${result.invoice_number}`);
                // document.getElementById('sales-form-container').reset(); // This might not work well with dynamic rows

                // Clear form fields manually
                customerContactInput.value = ''; // Clear contact input
                customerIdHiddenInput.value = ''; // Clear hidden ID
                customerNameInput.value = '';
                executiveNameSelect.value = ''; 
                discountInput.value = ''; // Set to blank
                modeOfPaymentInput.value = ''; // Reset mode of payment dropdown
                paymentOptionSelect.value = 'full-payment'; // Reset payment option
                partialAmountInput.value = ''; // Clear partial amount input
                notesInput.value = '';

                // Clear product rows except the first one
                while (productTable.rows.length > 1) productTable.deleteRow(1);
                while (productTableMobile.rows.length > 1) productTableMobile.deleteRow(1);

                // Reset the first row's content and re-attach listeners
                productTable.rows[0].innerHTML = desktopRowHTML;
                productTableMobile.rows[0].innerHTML = mobileRowHTML;

                populateProductDropdownsInRow(productTable.rows[0]);
                populateProductDropdownsInRow(productTableMobile.rows[0]);
                attachEventListenersToRow(productTable.rows[0]);
                attachEventListenersToRow(productTableMobile.rows[0]);

                salesDateInput.value = new Date().toISOString().split('T')[0];
                updatePaymentFields(); // Reset payment field visibility and values
                calculateTotal(); // Recalculate to reset all amounts to zero
            } else {
                alert(`Error: ${result.error || 'Failed to record sale.'}`);
            }
        } catch (error) {
            console.error('Error submitting sale:', error);
            alert('An error occurred while submitting the sale. Please try again.');
        }
    });

    // Add event listener for payment option change
    paymentOptionSelect.addEventListener('change', updatePaymentFields);
    // No need for partialAmountInput listener to update finalTotalAmountInput anymore as it's hidden
</script>
{% endblock %}
</body>
</html>
