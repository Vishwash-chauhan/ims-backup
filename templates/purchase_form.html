{% extends "base.html" %}

{% block content %}
<link href="{{ url_for('static', filename='custom.css') }}" rel="stylesheet">
<div class="min-h-screen flex justify-center items-center py-10 main-content">
    <div class="bg-white rounded-lg shadow-md w-full max-w-3xl p-6 form-container">
        <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo" class="mx-auto mb-4" style="max-width: 200px;">
        <h1 class="text-2xl font-semibold text-gray-800 mb-6 text-center">Purchase Entry</h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <label for="purchase-date" class="block text-gray-700 text-sm font-bold mb-2">Purchase Date:</label>
                <input type="date" id="purchase-date" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <label for="supplier-id" class="block text-gray-700 text-sm font-bold mb-2">Supplier ID:</label>
                <select id="supplier-id" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <option value="">Select Supplier ID</option>
                </select>
            </div>
            <div>
                <label for="supplier-name" class="block text-gray-700 text-sm font-bold mb-2">Supplier Name:</label>
                <input type="text" id="supplier-name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-500 leading-tight focus:outline-none focus:shadow-outline" readonly>
            </div>
        </div>

        <table id="product-table" class="mb-6">
            <thead>
                <tr>
                    <th>Product ID</th>
                    <th>Product Name</th>
                    <th>Quantity</th>
                    <th>Price Per Unit</th>
                    <th>Amount</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>
                        <select class="product-id shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            <option value="">Select Product ID</option>
                        </select>
                    </td>
                    <td>
                        <select class="product-name shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            <option value="">Select Product Name</option>
                        </select>
                    </td>
                    <td><input type="number" class="quantity-sold shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"></td>
                    <td><input type="number" class="price-per-unit shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"></td>
                    <td class="amount">₹0.00</td>
                </tr>
            </tbody>
        </table>

        <table id="product-table-mobile" class="mb-6">
            <thead>
                <tr>
                    <th>Product ID</th>
                    <th>Product Name</th>
                    <th>Quantity</th>
                    <th>Price Per Unit</th>
                    <th>Amount</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>
                        <label for="product-id-mobile-1">Product ID</label>
                        <select id="product-id-mobile-1" class="product-id shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            <option value="">Select Product ID</option>
                        </select>
                    </td>
                    <td>
                        <label for="product-name-mobile-1">Product Name</label>
                        <select id="product-name-mobile-1" class="product-name shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            <option value="">Select Product Name</option>
                        </select>
                    </td>
                    <td>
                        <label for="quantity-sold-mobile-1">Quantity</label>
                        <input type="number" id="quantity-sold-mobile-1" class="quantity-sold shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </td>
                    <td>
                        <label for="price-per-unit-mobile-1">Price Per Unit</label>
                        <input type="number" id="price-per-unit-mobile-1" class="price-per-unit shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </td>
                    <td class="amount">₹0.00</td>
                </tr>
            </tbody>
        </table>

        <div class="mb-6">
            <button id="add-product" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Add Product</button>
        </div>

        <div class="mb-4">
            <div class="w-1/2 pr-2">
                <label for="discount" class="block text-gray-700 text-sm font-bold mb-2">Discount Amount:</label>
                <input type="number" id="discount" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
        </div>

        <div id="total-and-gst-container" class="mb-6">
            <div class="mb-2">
                <span class="text-gray-700 text-sm font-bold">Total Amount: </span>
                <span id="total-amount" class="text-gray-700">₹0.00</span>
            </div>
            <div class="mb-2">
                <span class="text-gray-700 text-sm font-bold">Discount Amount: </span>
                <span id="discount-amount" class="text-gray-700">₹0.00</span>
            </div>
            <div class="mb-2">
                <span class="text-gray-700 text-sm font-bold">GST: </span>
                <span id="cgst" class="text-gray-700">₹0.00</span>
            </div>
            <div class="mb-2">
                <span class="text-gray-700 text-sm font-bold">Total Payable Amount: </span>
                <span id="total-payable-amount" class="text-gray-700">₹0.00</span>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <label for="mode-of-payment" class="block text-gray-700 text-sm font-bold mb-2">Mode of Payment:</label>
                <input type="text" id="mode-of-payment" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <div>
                <label for="payment-option" class="block text-gray-700 text-sm font-bold mb-2">Payment Option:</label>
                <select id="payment-option" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <option value="full-payment" selected>Full Payment</option>
                    <option value="partial-payment">Partial Payment</option>
                </select>
            </div>
        </div>

        <div class="mb-4 show-partial-payment" id="partial-payment-amount">
            <label for="amount" class="block text-gray-700 text-sm font-bold mb-2">Partial Payment Amount:</label>
            <input type="number" id="amount" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
        </div>

        <div id="final-total-amount-container" class="mb-6">
            <label class="block text-gray-700 text-sm font-bold mb-2">Amount Paid:</label>
            <input type="text" id="final-total-amount" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" readonly>
        </div>

        <button id="submit-form" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Submit</button>
        <div style="display: flex; justify-content: flex-end; margin-top: 16px;">
            <a href="{{ url_for('main.purchase_return') }}" class="btn btn-secondary" style="padding: 12px 24px; background: #f4f7fa; color: #023f90; border: 2px solid #023f90; border-radius: 8px; font-size: 16px; text-decoration: none; transition: background 0.2s, color 0.2s;">
                Purchase Return
            </a>
        </div>
    </div>
</div>

<script>
    const paymentOptionSelect = document.getElementById('payment-option');
    const partialPaymentAmountInput = document.getElementById('partial-payment-amount');
    const addProductButton = document.getElementById('add-product');
    const productTable = document.getElementById('product-table');
    const productTableMobile = document.getElementById('product-table-mobile');
    const totalAmountDisplay = document.getElementById('total-amount');
    const cgstDisplay = document.getElementById('cgst');
    const finalTotalAmountInput = document.getElementById('final-total-amount');
    const finalTotalAmountContainer = document.getElementById('final-total-amount-container');
    const totalPayableAmountDisplay = document.getElementById('total-payable-amount');
    const supplierIdSelect = document.getElementById('supplier-id');
    const supplierNameInput = document.getElementById('supplier-name');
    const purchaseDateInput = document.getElementById('purchase-date');
    const discountInput = document.getElementById('discount'); // New
    const discountAmountDisplay = document.getElementById('discount-amount'); // New
    // const executiveNameSelect = document.getElementById('executive-name'); // Removed

    // Sample supplier data (in a real application, this would come from a database)
    const supplierData = {
        'S001': 'ABC Corp',
        'S002': 'XYZ Ltd',
        'S003': 'PQR Inc',
        'S004': 'LMN Group',
        'S005': 'UVW Enterprises'
    };

    // Sample executive names
    // const executiveNames = ['Alice Johnson', 'Bob Williams', 'Charlie Brown', 'Diana Miller', 'Ethan Davis']; // Removed

    // Sample product data (In real app, this would come from DB)
    const productData = {
        'P001': 'Laptop',
        'P002': 'Mouse',
        'P003': 'Keyboard',
        'P004': 'Monitor',
        'P005': 'Printer',
        'P006': 'Software License',
        'P007': 'Webcam',
        'P008': 'External Hard Drive',
        'P009': 'USB Hub',
        'P010': 'Headphones'
    };

    // Function to populate product dropdowns
    function populateProductDropdowns(productIdSelect, productNameSelect) {
        productIdSelect.innerHTML = '<option value="">Select Product ID</option>';
        productNameSelect.innerHTML = '<option value="">Select Product Name</option>';
        for (const productId in productData) {
            const optionId = document.createElement('option');
            optionId.value = productId;
            optionId.textContent = productId;
            productIdSelect.appendChild(optionId);

            const optionName = document.createElement('option');
            optionName.value = productData[productId];
            optionName.textContent = productData[productId];
            productNameSelect.appendChild(optionName);
        }
    }

    // Populate the Supplier ID dropdown
    for (const supplierId in supplierData) {
        const option = document.createElement('option');
        option.value = supplierId;
        option.textContent = supplierId;
        supplierIdSelect.appendChild(option);
    }

    // Set default value for Purchase Date to today
    purchaseDateInput.value = new Date().toISOString().split('T')[0];

    // Update Supplier Name when Supplier ID is selected
    supplierIdSelect.addEventListener('change', function() {
        const selectedSupplierId = this.value;
        const supplierName = supplierData[selectedSupplierId] || ''; // Default to empty string if ID not found
        supplierNameInput.value = supplierName;
    });

    paymentOptionSelect.addEventListener('change', function() {
        if (this.value === 'partial-payment') {
            partialPaymentAmountInput.classList.add('show-partial-payment');
            finalTotalAmountInput.readOnly = false;
            finalTotalAmountInput.value = '';
        } else {
            partialPaymentAmountInput.classList.remove('show-partial-payment');
            finalTotalAmountInput.readOnly = true;
            calculateTotal();
        }
    });

    addProductButton.addEventListener('click', function() {
        let newRow;
        if (window.innerWidth < 768) {
            newRow = productTableMobile.insertRow();
            const cell1 = newRow.insertCell();
            const cell2 = newRow.insertCell();
            const cell3 = newRow.insertCell();
            const cell4 = newRow.insertCell();
            const cell5 = newRow.insertCell();

            // Product ID Dropdown
            const productIdSelect = document.createElement('select');
            productIdSelect.className = 'product-id shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline';
            
            // Product Name Dropdown
            const productNameSelect = document.createElement('select');
            productNameSelect.className = 'product-name shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline';
            
            populateProductDropdowns(productIdSelect, productNameSelect); // Populate dropdowns for new row

            cell1.appendChild(productIdSelect);
            cell2.appendChild(productNameSelect);
            cell3.innerHTML = `<label for="quantity-sold-mobile-${productTableMobile.rows.length}">Quantity</label><input type="number" id="quantity-sold-mobile-${productTableMobile.rows.length}" class="quantity-sold shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">`;
            cell4.innerHTML = `<label for="price-per-unit-mobile-${productTableMobile.rows.length}">Price Per Unit</label><input type="number" id="price-per-unit-mobile-${productTableMobile.rows.length}" class="price-per-unit shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">`;
            cell5.className = 'amount';
            cell5.textContent = '₹0.00';

            // Event Listeners for mobile
            productIdSelect.addEventListener('change', function() {
                const selectedProductId = this.value;
                const productName = productData[selectedProductId] || '';
                productNameSelect.value = productName;
                calculateTotal(); // Recalculate on change
            });

            productNameSelect.addEventListener('change', function() {
                const selectedProductName = this.value;
                let productId = '';
                for (const id in productData) {
                    if (productData[id] === selectedProductName) {
                        productId = id;
                        break;
                    }
                }
                productIdSelect.value = productId;
                calculateTotal(); // Recalculate on change
            });

        }
        else{
            newRow = productTable.insertRow();
            const cell1 = newRow.insertCell();
            const cell2 = newRow.insertCell();
            const cell3 = newRow.insertCell();
            const cell4 = newRow.insertCell();
            const cell5 = newRow.insertCell();

            // Product ID Dropdown
            const productIdSelect = document.createElement('select');
            productIdSelect.className = 'product-id shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline';
            
            // Product Name Dropdown
            const productNameSelect = document.createElement('select');
            productNameSelect.className = 'product-name shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline';
            
            populateProductDropdowns(productIdSelect, productNameSelect); // Populate dropdowns for new row

            cell1.appendChild(productIdSelect);
            cell2.appendChild(productNameSelect);

            cell3.innerHTML = `<input type="number" class="quantity-sold shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">`;
            cell4.innerHTML = `<input type="number" class="price-per-unit shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">`;
            cell5.className = 'amount';
            cell5.textContent = '₹0.00';
            // Event Listeners
            productIdSelect.addEventListener('change', function() {
                const selectedProductId = this.value;
                const productName = productData[selectedProductId] || '';
                productNameSelect.value = productName;
                calculateTotal(); // Recalculate on change
            });

            productNameSelect.addEventListener('change', function() {
                const selectedProductName = this.value;
                let productId = '';
                for (const id in productData) {
                    if (productData[id] === selectedProductName) {
                        productId = id;
                        break;
                    }
                }
                productIdSelect.value = productId;
                calculateTotal(); // Recalculate on change
            });
        }

        // Re-calculate total when fields in the new row change
        const inputs = newRow.querySelectorAll('input');
        inputs.forEach(input => {
            input.addEventListener('change', calculateTotal);
        });
         const selects = newRow.querySelectorAll('select');
        selects.forEach(select => {
            select.addEventListener('change', calculateTotal);
        });
    });

    function formatIndianCurrency(amount) {
        const formatter = new Intl.NumberFormat('en-IN', {
            style: 'currency',
            currency: 'INR',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
        });
        return formatter.format(amount);
    }

    function calculateTotal() {
        let total = 0;
        let discountAmount = 0;
        let rows;
        if (window.innerWidth < 768) {
            rows = productTableMobile.querySelectorAll('tbody tr');
        }
        else{
            rows = productTable.querySelectorAll('tbody tr');
        }

        rows.forEach(row => {
            const quantityInput = row.querySelector('.quantity-sold');
            const pricePerUnitInput = row.querySelector('.price-per-unit');
            const amountCell = row.querySelector('.amount');
            const productIdSelect = row.querySelector('.product-id');
            const productNameSelect = row.querySelector('.product-name');
            const quantity = parseFloat(quantityInput.value);
            const pricePerUnit = parseFloat(pricePerUnitInput.value);
            const selectedProductId = productIdSelect.value;
            const productName = productData[selectedProductId] || '';
            productNameSelect.value = productName;

            if (!isNaN(quantity) && !isNaN(pricePerUnit)) {
                const amount = quantity * pricePerUnit;
                amountCell.textContent = formatIndianCurrency(amount);
                total += amount;
            } else {
                amountCell.textContent = '₹0.00';
            }
        });

        const discount = parseFloat(discountInput.value);
        if (!isNaN(discount)) {
            discountAmount = discount;
            total = total - discountAmount;
            if (total < 0) total = 0;
        }

        totalAmountDisplay.textContent = formatIndianCurrency(total + discountAmount); // Show pre-discount total
        discountAmountDisplay.textContent = formatIndianCurrency(discountAmount);
        const cgst = total * 0.18;
        cgstDisplay.textContent = formatIndianCurrency(cgst);
        const totalPayable = total + cgst;
        totalPayableAmountDisplay.textContent = formatIndianCurrency(totalPayable);

        if (paymentOptionSelect.value === 'partial-payment') {
            const partialPaymentAmount = parseFloat(document.getElementById('amount').value);
            if (!isNaN(partialPaymentAmount)) {
                finalTotalAmountInput.value = formatIndianCurrency(partialPaymentAmount);
            } else {
                finalTotalAmountInput.value = '';
            }
        } else {
            finalTotalAmountInput.value = formatIndianCurrency(totalPayable);
        }
    }

    // Event listener for partial payment amount input
    document.getElementById('amount').addEventListener('input', function() {
        if (paymentOptionSelect.value === 'partial-payment') {
            const partialPaymentAmount = parseFloat(this.value);
            if (!isNaN(partialPaymentAmount)) {
                finalTotalAmountInput.value = formatIndianCurrency(partialPaymentAmount);
            } else {
                finalTotalAmountInput.value = '';
            }
        }
    });

     // Event listener for discount input
    discountInput.addEventListener('input', function() {
        calculateTotal();
    });

    // Calculate initial total on page load and add event listeners to existing rows
    calculateTotal();

    // Populate the initial product dropdowns on page load
    const initialProductIdSelect = productTable.querySelector('.product-id');
    const initialProductNameSelect = productTable.querySelector('.product-name');
    populateProductDropdowns(initialProductIdSelect, initialProductNameSelect);

    const initialMobileProductIdSelect = productTableMobile.querySelector('.product-id');
    const initialMobileProductNameSelect = productTableMobile.querySelector('.product-name');
    populateProductDropdowns(initialMobileProductIdSelect, initialMobileProductNameSelect);


    const initialRows = productTable.querySelectorAll('tbody tr');
    initialRows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        inputs.forEach(input => {
            input.addEventListener('change', calculateTotal);
        });
        const selects = row.querySelectorAll('select');
        selects.forEach(select => {
            select.addEventListener('change', calculateTotal);
        });
    });

    const initialMobileRows = productTableMobile.querySelectorAll('tbody tr');
    initialMobileRows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        inputs.forEach(input => {
            input.addEventListener('change', calculateTotal);
        });
        const selects = row.querySelectorAll('select');
        selects.forEach(select => {
            select.addEventListener('change', calculateTotal);
        });
    });
</script>
{% endblock %}
